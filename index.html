<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quema Infiel</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üî• Quema Infiel üî•</h1>
            <p>El lugar donde la verdad sale a la luz.</p>
        </header>

        <div id="auth-container">
            <div id="login-form">
                <h2>Iniciar Sesi√≥n</h2>
                <input type="text" id="login-username" placeholder="Usuario" required>
                <input type="password" id="login-password" placeholder="Contrase√±a" required>
                <button id="login-btn">Entrar</button>
                <p>¬øNo tienes cuenta? <a href="#" id="show-register">Reg√≠strate</a></p>
            </div>

            <div id="register-form" style="display: none;">
                <h2>Registrarse</h2>
                <input type="text" id="register-username" placeholder="Usuario" required>
                <input type="password" id="register-password" placeholder="Contrase√±a" required>
                <button id="register-btn">Crear Cuenta</button>
                <p>¬øYa tienes cuenta? <a href="#" id="show-login">Inicia Sesi√≥n</a></p>
            </div>
        </div>

        <main id="main-content" style="display: none;">
            <div class="user-info">
                <span id="user-welcome">Bienvenido, <span id="user-name"></span></span>
                <span id="user-credits">Cr√©ditos: <span id="credits-amount">0</span></span>
            </div>
            <nav>
                <button id="btn-muro">Muro P√∫blico</button>
                <button id="btn-quemar">Quemar a un Infiel</button>
                <button id="btn-recargar">Recargar Cr√©ditos</button>
            </nav>

            <section id="muro-section" class="content-section">
                <h2>Muro de los Infieles</h2>
                <div id="muro-posts">
                    <!-- Los posts se cargar√°n aqu√≠ -->
                </div>
            </section>

            <section id="quemar-section" class="content-section" style="display: none;">
                <h2>Quemar a un Infiel</h2>
                <form id="form-quemar">
                    <input type="text" id="inf-nombre" placeholder="Nombre del infiel" required>
                    <input type="text" id="inf-redes" placeholder="Redes sociales (ej: @usuario)">
                    <input type="text" id="inf-edad" placeholder="Edad">
                    <input type="text" id="inf-origen" placeholder="Origen (ej: Lima - Surco)">
                    <textarea id="inf-evidencias" placeholder="Describe las evidencias..." required></textarea>
                    <input type="file" id="inf-foto" accept="image/*" required>
                    <p>Costo: <span id="costo-quemar">10</span> cr√©ditos.</p>
                    <button type="submit">Enviar Solicitud</button>
                </form>
                <div id="pago-yape-section" style="display: none;">
                    <h3>Paga con Yape</h3>
                    <p>Escanea el c√≥digo QR para pagar los <span id="costo-quemar-2">10</span> cr√©ditos.</p>
                    <!-- Aqu√≠ ir√≠a tu c√≥digo QR de Yape -->
                    <img src="https://i.imgur.com/gQzXk0c.png" alt="C√≥digo QR Yape" style="width: 200px; height: 200px;">
                    <p>Una vez hecho el pago, haz clic en el bot√≥n para notificar.</p>
                    <button id="btn-notificar-pago">He pagado</button>
                </div>
            </section>

            <section id="recargar-section" class="content-section" style="display: none;">
                <h2>Recargar Cr√©ditos</h2>
                <p>1 sol = 1 cr√©dito.</p>
                <input type="number" id="recarga-creditos" placeholder="¬øCu√°ntos cr√©ditos quieres?" min="1" required>
                <button id="btn-solicitar-recarga">Generar Solicitud</button>
                <div id="pago-recarga-section" style="display: none;">
                    <h3>Paga con Yape</h3>
                    <p>Monto a pagar: S/ <span id="monto-recarga">0</span></p>
                    <p>Escanea el c√≥digo QR para pagar.</p>
                    <img src="https://i.imgur.com/gQzXk0c.png" alt="C√≥digo QR Yape" style="width: 200px; height: 200px;">
                    <p>Una vez hecho el pago, haz clic en el bot√≥n para notificar.</p>
                    <button id="btn-notificar-pago-recarga">He pagado</button>
                </div>
            </section>

            <div id="post-detail-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <div id="post-detail-content">
                        <!-- El contenido del post se cargar√° aqu√≠ -->
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const API_URL = 'https://quema-infiel.onrender.com'; // ¬°CAMBIA ESTO POR TU URL DE RENDER!

        let currentUser = null;

        // Elementos del DOM
        const authContainer = document.getElementById('auth-container');
        const mainContent = document.getElementById('main-content');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');

        // Botones y secciones
        const btnMuro = document.getElementById('btn-muro');
        const btnQuemar = document.getElementById('btn-quemar');
        const btnRecargar = document.getElementById('btn-recargar');
        const muroSection = document.getElementById('muro-section');
        const quemarSection = document.getElementById('quemar-section');
        const recargarSection = document.getElementById('recargar-section');

        // --- L√ìGICA DE AUTENTICACI√ìN ---
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
        });

        document.getElementById('register-btn').addEventListener('click', async () => {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            if (!username || !password) return alert('Completa todos los campos.');

            const response = await fetch(`\${API_URL}/api/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (data.ok) {
                alert('Usuario creado. Ahora inicia sesi√≥n.');
                showLoginLink.click();
            } else {
                alert(data.message);
            }
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            if (!username || !password) return alert('Completa todos los campos.');

            const response = await fetch(`\${API_URL}/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (data.ok) {
                currentUser = data.user;
                document.getElementById('user-name').textContent = currentUser.username;
                document.getElementById('credits-amount').textContent = currentUser.credits;
                authContainer.style.display = 'none';
                mainContent.style.display = 'block';
                loadMuro();
            } else {
                alert(data.message);
            }
        });

        // --- L√ìGICA DE NAVEGACI√ìN ---
        function hideAllSections() {
            muroSection.style.display = 'none';
            quemarSection.style.display = 'none';
            recargarSection.style.display = 'none';
        }

        btnMuro.addEventListener('click', () => {
            hideAllSections();
            muroSection.style.display = 'block';
            loadMuro();
        });

        btnQuemar.addEventListener('click', () => {
            hideAllSections();
            quemarSection.style.display = 'block';
            document.getElementById('pago-yape-section').style.display = 'none';
            document.getElementById('form-quemar').reset();
        });

        btnRecargar.addEventListener('click', () => {
            hideAllSections();
            recargarSection.style.display = 'block';
            document.getElementById('pago-recarga-section').style.display = 'none';
            document.getElementById('recarga-creditos').value = '';
        });

        // --- L√ìGICA DEL MURO ---
        async function loadMuro() {
            const response = await fetch(`\${API_URL}/api/muro-publico`);
            const data = await response.json();
            const muroPostsDiv = document.getElementById('muro-posts');
            muroPostsDiv.innerHTML = '';
            if (data.ok && data.posts.length > 0) {
                data.posts.forEach(post => {
                    const postDiv = document.createElement('div');
                    postDiv.className = 'post-card';
                    postDiv.innerHTML = `<h3>\${post.nombre}</h3>`;
                    postDiv.addEventListener('click', () => showPostDetail(post.id));
                    muroPostsDiv.appendChild(postDiv);
                });
            } else {
                muroPostsDiv.innerHTML = '<p>No hay confesiones p√∫blicas por ahora.</p>';
            }
        }

        // --- L√ìGICA DE DETALLE DEL POST ---
        const modal = document.getElementById('post-detail-modal');
        const postDetailContent = document.getElementById('post-detail-content');
        const closeBtn = document.querySelector('.close-btn');

        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });

        async function showPostDetail(postId) {
            const response = await fetch(`\${API_URL}/api/posts/detalles`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ postId, userId: currentUser.id })
            });
            const data = await response.json();

            if (data.ok) {
                const fullPost = data.post;
                // <-- ¬°L√çNEA CORREGIDA! Se usan comillas invertidas ` ` en lugar de comillas simples ' '
                postDetailContent.innerHTML = `
                    <div class="post-detail">
                        <h2>\${fullPost.nombre}</h2>
                        <p><strong>Redes:</strong> \${fullPost.redes}</p>
                        <p><strong>Edad:</strong> \${fullPost.edad}</p>
                        <p><strong>Origen:</strong> \${fullPost.origen}</p>
                        <div class="evidence-section">
                            <h3>Evidencias:</h3>
                            <p>\${fullPost.evidencias}</p>
                        </div>
                        <div class="photo-section">
                            <img src="\${fullPost.fotoBase64}" alt="Foto del infiel">
                        </div>
                    </div>
                `;
                document.getElementById('credits-amount').textContent = currentUser.credits;
                modal.style.display = 'block';
            } else {
                alert(data.message);
            }
        }


        // --- L√ìGICA DE QUEMAR ---
        let currentPostId = null;
        document.getElementById('form-quemar').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (currentUser.credits < 10) {
                alert('No tienes suficientes cr√©ditos para quemar.');
                return;
            }
            const formData = new FormData(e.target);
            const fotoFile = formData.get('foto');
            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64String = reader.result;
                const response = await fetch(`\${API_URL}/api/solicitar-quemada`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        nombre: document.getElementById('inf-nombre').value,
                        redes: document.getElementById('inf-redes').value,
                        edad: document.getElementById('inf-edad').value,
                        origen: document.getElementById('inf-origen').value,
                        evidencias: document.getElementById('inf-evidencias').value,
                        fotoBase64: base64String
                    })
                });
                const data = await response.json();
                if (data.ok) {
                    currentPostId = data.postId;
                    document.getElementById('form-quemar').style.display = 'none';
                    document.getElementById('pago-yape-section').style.display = 'block';
                } else {
                    alert(data.message);
                }
            };
            reader.readAsDataURL(fotoFile);
        });

        document.getElementById('btn-notificar-pago').addEventListener('click', async () => {
            if (!currentPostId) return;
            const response = await fetch(`\${API_URL}/api/registrar-pago-yape`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ postId: currentPostId, monto: 10 })
            });
            const data = await response.json();
            if (data.ok) {
                alert('Pago notificado. Espera la validaci√≥n del admin.');
                btnQuemar.click();
            } else {
                alert(data.message);
            }
        });

        // --- L√ìGICA DE RECARGAR ---
        let currentRecargaId = null;
        document.getElementById('btn-solicitar-recarga').addEventListener('click', async () => {
            const creditos = parseInt(document.getElementById('recarga-creditos').value);
            if (!creditos || creditos <= 0) return alert('Cantidad de cr√©ditos inv√°lida.');

            const response = await fetch(`\${API_URL}/api/solicitar-recarga`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: currentUser.id, creditos })
            });
            const data = await response.json();
            if (data.ok) {
                currentRecargaId = data.recargaId;
                document.getElementById('monto-recarga').textContent = data.monto;
                document.getElementById('btn-solicitar-recarga').style.display = 'none';
                document.getElementById('pago-recarga-section').style.display = 'block';
            } else {
                alert(data.message);
            }
        });

        document.getElementById('btn-notificar-pago-recarga').addEventListener('click', async () => {
            if (!currentRecargaId) return;
            const response = await fetch(`\${API_URL}/api/registrar-pago-recarga`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ recargaId: currentRecargaId })
            });
            const data = await response.json();
            if (data.ok) {
                alert('Pago de recarga notificado. Espera la validaci√≥n del admin.');
                btnRecargar.click();
            } else {
                alert(data.message);
            }
        });
    </script>
</body>
</html>